<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.6d295891da8f41c56fad.css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}a{background-color:transparent}code{font-family:monospace,monospace;font-size:1em}img{border-style:none}button,input{font-family:inherit;font-size:100%;line-height:1.15;margin:0;overflow:visible}button{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}progress{vertical-align:baseline}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}[hidden]{display:none}html{box-sizing:border-box;font-family:sans-serif}*,:after,:before{box-sizing:inherit}blockquote,figure,h1,h2,h3,hr,p{margin:0}button{background:transparent;padding:0}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}ol,ul{margin:0;padding:0;list-style:none}html{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}*,:after,:before{border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}input::-webkit-input-placeholder{color:#a0aec0}input::-moz-placeholder{color:#a0aec0}input:-ms-input-placeholder{color:#a0aec0}input::-ms-input-placeholder{color:#a0aec0}input::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}h1,h2,h3{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input{padding:0;line-height:inherit;color:inherit}code{font-family:SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}embed,img,svg{display:block;vertical-align:middle}img{max-width:100%;height:auto}.bg-gray-200{background-color:#edf2f7}.bg-gray-900{background-color:#1a202c}.bg-red-400{background-color:#fc8181}.bg-yellow-400{background-color:#f6e05e}.bg-green-100{background-color:#f0fff4}.hover\:bg-green-500:hover{background-color:#48bb78}.border-white{border-color:#fff}.border-gray-300{border-color:#e2e8f0}.rounded{border-radius:.25rem}.rounded-full{border-radius:9999px}.border{border-width:1px}.border-l-4{border-left-width:4px}.cursor-pointer{cursor:pointer}.block{display:block}.inline-block{display:inline-block}.flex{display:-webkit-box;display:flex}.hidden{display:none}.flex-col{-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{-webkit-box-align:center;align-items:center}.justify-between{-webkit-box-pack:justify;justify-content:space-between}.flex-1{-webkit-box-flex:1;flex:1 1 0%}.font-semibold{font-weight:600}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.h-3{height:.75rem}.leading-loose{line-height:2}.list-disc{list-style-type:disc}.list-decimal{list-style-type:decimal}.list-square{list-style-type:square}.my-2{margin-top:.5rem;margin-bottom:.5rem}.my-8{margin-top:2rem;margin-bottom:2rem}.mx-auto{margin-left:auto;margin-right:auto}.mr-2{margin-right:.5rem}.mb-2{margin-bottom:.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mr-6{margin-right:1.5rem}.mt-8{margin-top:2rem}.mr-8{margin-right:2rem}.max-w-sm{max-width:24rem}.max-w-4xl{max-width:56rem}.min-h-screen{min-height:100vh}.opacity-25{opacity:.25}.opacity-50{opacity:.5}.overflow-hidden{overflow:hidden}.p-3{padding:.75rem}.p-4{padding:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-8{padding-top:2rem;padding-bottom:2rem}.pl-4{padding-left:1rem}.absolute{position:absolute}.top-0{top:0}.right-0{right:0}.shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}.focus\:shadow-outline:focus{box-shadow:0 0 0 3px rgba(66,153,225,.5)}.fill-current{fill:currentColor}.text-center{text-align:center}.text-justify{text-align:justify}.text-white{color:#fff}.text-gray-600{color:#718096}.text-gray-700{color:#4a5568}.text-gray-800{color:#2d3748}.text-gray-900{color:#1a202c}.text-blue-300{color:#90cdf4}.text-xs{font-size:.75rem}.text-sm{font-size:.875rem}.text-base{font-size:1rem}.text-xl{font-size:1.25rem}.text-2xl{font-size:1.5rem}.text-3xl{font-size:1.875rem}.uppercase{text-transform:uppercase}.underline{text-decoration:underline}.line-through{text-decoration:line-through}.no-underline{text-decoration:none}.tracking-tight{letter-spacing:-.025em}.invisible{visibility:hidden}.w-3{width:.75rem}.w-1\/2{width:50%}.w-full{width:100%}.z-0{z-index:0}.z-40{z-index:40}@media (min-width:640px){.sm\:w-full{width:100%}}@media (min-width:768px){.md\:block{display:block}.md\:inline-block{display:inline-block}.md\:flex{display:-webkit-box;display:flex}.md\:hidden{display:none}.md\:flex-row{-webkit-box-orient:horizontal;-webkit-box-direction:normal;flex-direction:row}.md\:items-center{-webkit-box-align:center;align-items:center}.md\:justify-center{-webkit-box-pack:center;justify-content:center}.md\:mt-0{margin-top:0}.md\:ml-6{margin-left:1.5rem}.md\:p-8{padding:2rem}.md\:py-8{padding-top:2rem;padding-bottom:2rem}.md\:pl-0{padding-left:0}.md\:pr-8{padding-right:2rem}.md\:w-auto{width:auto}.md\:w-5\/6{width:83.333333%}.md\:w-1\/12{width:8.333333%}}@media (min-width:1024px){.lg\:w-1\/4{width:25%}.lg\:w-2\/4{width:50%}}.header-logo{color:#2f906a}@font-face{font-family:ET Book;src:url(/static/et-book-roman-line-figures-10d6df6a575fb60ab98d2a7d3792642a.woff) format("woff2")}body{font-family:ET Book,serif}.logo{font-family:Poppins,sans-serif}.layout-bg{background:#fbf2da}.layout-overlay{background:#f9ebc4}.side-overlay{background:#b7f4c4}p{text-indent:1.5em}.link-cl{color:#d46240;font-style:oblique}</style><meta name="generator" content="Gatsby 2.18.17"/><title data-react-helmet="true">Prototyping a SaaS Backend with Responder and EdgeDB | unintendedcon</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Poppins&amp;display=swap" rel="stylesheet"/><meta data-react-helmet="true" name="description" content="Building a backend is hard, especially when bootstrapping a SaaS. Here&#x27;s how to handle the auth part, using Responder and EdgeDB."/><meta data-react-helmet="true" property="og:title" content="Prototyping a SaaS Backend with Responder and EdgeDB"/><meta data-react-helmet="true" property="og:description" content="Building a backend is hard, especially when bootstrapping a SaaS. Here&#x27;s how to handle the auth part, using Responder and EdgeDB."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Jonathan Wong"/><meta data-react-helmet="true" name="twitter:title" content="Prototyping a SaaS Backend with Responder and EdgeDB"/><meta data-react-helmet="true" name="twitter:description" content="Building a backend is hard, especially when bootstrapping a SaaS. Here&#x27;s how to handle the auth part, using Responder and EdgeDB."/><meta data-react-helmet="true" name="google-site-verification" content="QdsDyjRqmPbvXdHsBhERu19L8gm8hQ0e-12qx1cFbCY"/><meta data-react-helmet="true" name="keywords" content="SaaS, EdgeDB, Authentication, Responder, Python"/><link rel="icon" href="/icons/icon-48x48.png?v=c34c91198f96b2d364874cff69e25c13"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#4dc0b5"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=c34c91198f96b2d364874cff69e25c13"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=c34c91198f96b2d364874cff69e25c13"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=c34c91198f96b2d364874cff69e25c13"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=c34c91198f96b2d364874cff69e25c13"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=c34c91198f96b2d364874cff69e25c13"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=c34c91198f96b2d364874cff69e25c13"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=c34c91198f96b2d364874cff69e25c13"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=c34c91198f96b2d364874cff69e25c13"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/webpack-runtime-3e419a0487a4c0ed2972.js"/><link as="script" rel="preload" href="/app-c82e8ac8a837da01f4a6.js"/><link as="script" rel="preload" href="/styles-2672c646f9c7f9af2d1c.js"/><link as="script" rel="preload" href="/commons-7eee34bc71505e22bd57.js"/><link as="script" rel="preload" href="/component---src-templates-blog-template-js-68229942d75118d4628d.js"/><link as="fetch" rel="preload" href="/page-data/articles/2020-01-16-prototyping-a-relational-saas-backend-using-responder-and-edgedb/page-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
        var mode = localStorage.getItem('theme-ui-color-mode');
        if (!mode) return
        document.body.classList.add('theme-ui-' + mode);
      } catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="19xuea9">body{--theme-ui-colors-text:var(--theme-ui-colors-text,#fff);--theme-ui-colors-background:var(--theme-ui-colors-background,#151515);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#A5F);color:var(--theme-ui-colors-text,var(--theme-ui-colors-text,#fff));background-color:var(--theme-ui-colors-background,var(--theme-ui-colors-background,#151515));}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#fff);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#151515);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#A5F);}</style><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="flex flex-col font-sans min-h-screen text-gray-900 layout-bg"><header class="z-40"><div class="flex flex-wrap items-center justify-between max-w-4xl mx-auto p-4 md:p-8"><a class="flex items-center no-underline header-logo" href="/"><span class="font-bold text-xl tracking-tight logo">unintendedcon</span></a><button class="block md:hidden border border-white flex items-center px-3 py-2 rounded text-white"><svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg></button><nav class="hidden md:block md:flex md:items-center w-full md:w-auto"><a class="block md:inline-block mt-4 md:mt-0 md:ml-6 no-underline text-white" href="/goals">#2020goals</a><a class="block md:inline-block mt-4 md:mt-0 md:ml-6 no-underline text-white" href="/lists">lists</a><a class="block md:inline-block mt-4 md:mt-0 md:ml-6 no-underline text-white" href="/blog">blog</a><a class="block md:inline-block mt-4 md:mt-0 md:ml-6 no-underline text-white" href="/photos">photos</a><a class="block md:inline-block mt-4 md:mt-0 md:ml-6 no-underline text-white" href="/contact">contact</a></nav></div><div class="flex"><hr class="lg:w-1/4 md:w-1/12 invisible"/><hr class="sm:w-full md:w-5/6 lg:w-2/4"/></div></header><svg class="absolute z-0 top-0 right-0 opacity-50" width="819" height="298" viewBox="0 0 819 298" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M283.935 267.374C160.221 283.924 46.5144 197.049 29.9651 73.3348C13.4158 -50.3796 100.29 -164.086 224.005 -180.635L892.054 -270L951.984 178.009L283.935 267.374Z" fill="url(#paint0_linear)"></path><defs><linearGradient id="paint0_linear" x1="29.9651" y1="73.3348" x2="714" y2="-129" gradientUnits="userSpaceOnUse"><stop stop-color="#C94B4B"></stop><stop offset="0.86501" stop-color="#4B134F"></stop></linearGradient></defs></svg><main class="flex flex-col flex-1 md:justify-center max-w-4xl mx-auto px-4 py-8 md:p-8 w-full z-40"><section class="text-gray-900"><h1 class="text-3xl">Prototyping a SaaS Backend with Responder and EdgeDB</h1><p>2020-01-16 21:17 -0400</p><div><html><head></head><body><p class="mt-8 leading-loose">This guide is best for people who want to get started with bootstrapping a SaaS in a fast manner, but with a relational database. There are a number of reasons to pick a relational database over a NoSQL database, but we won&apos;t go over them here.</p>
<p class="mt-8 leading-loose">We are going to use <a href="https://responder.kennethreitz.org/en/latest/index.html" class="text-gray-700 font-bold bg-red-400">responder</a>, a web and API framework, developed by Kenneth Reitz to interface with our database, <a href="https://edgedb.com" class="text-gray-700 font-bold bg-red-400">EdgeDB</a>, by <a href="http://magic.io" class="text-gray-700 font-bold bg-red-400">magicstack</a>. These were picked because of their relative simplicity and easiness to learn.</p>
<h2 class="text-3xl mt-8">Initial API setup</h2>
<p class="mt-8 leading-loose">To start, you should install a python package manager for your system. The one I recommend, is <code class="bg-gray-900">pipenv</code> as it allows you to easily port and share your projects with other people. <a href="https://pipenv.kennethreitz.org/en/latest/" class="text-gray-700 font-bold bg-red-400">Pipenv</a> can be downloaded from PyPa or your system package manager.</p>
<p class="mt-8 leading-loose">Once you have pipenv set up, you should install our required packages. We will be using three, <code class="bg-gray-900">responder</code>, <code class="bg-gray-900">edgedb</code>, and <code class="bg-gray-900">validators</code>. Validators takes care of some basic data and form validation for us.</p>
<pre><code class="language-shell bg-gray-900">pipenv install responder edgedb validators
</code></pre>
<p class="mt-8 leading-loose">We now have the libraries neccesary for establishing our python API. We can now create a file, called <em class="italics">main.py</em> to house our API code. It really doesn&apos;t matter what this file name is, so feel free to change it.</p>
<pre><code class="bg-gray-900">touch main.py
</code></pre>
<p class="mt-8 leading-loose">Responder is an ASGI framework, which means that we can do asynchronous operations. To create a basic responder app, we can follow the tutorial and define a simple endpoint.</p>
<pre><code class="language-python bg-gray-900">import responder

api = responder.API()
@api.route(&quot;/{greeting}&quot;)
async def greet_world(req, res, *, greeting):
    resp.text = f&quot;{greeting}, world!&quot;

if __name__ == &apos;__main__&apos;:
    api.run()
</code></pre>
<p class="mt-8 leading-loose">Let&apos;s go over this code line by line.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">import responder</code> imports the responder library, so that we can use it later.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">api = responder.API()</code> establishes a responder app that we can run.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">@api.route(&quot;/{greeting}&quot;)</code> declares that this API has an endpoint or route. If you&apos;re unsure of what an endpoint is, then think of it as a specific page or pattern of pages. The route we&apos;re setting up here is dynamic, and pattern-based. The variable, <code class="bg-gray-900">greeting</code> is enclosed in curly brackets to show that this is a dynamic route.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">async def greet_world(req, res, *, greeting):</code> declares a function that should run when a client (user) visits this endpoint. <code class="bg-gray-900">greet_world</code> takes 4 paramaters, <code class="bg-gray-900">req</code>, <code class="bg-gray-900">res</code>, <code class="bg-gray-900">*</code>, and <code class="bg-gray-900">greeting</code>. <code class="bg-gray-900">req</code> and <code class="bg-gray-900">res</code> stand for request and response, and represent the data coming to the server and the data coming out. <code class="bg-gray-900">*</code> is needed because we are using dynamic routes, which require an unknown amount of variables for endpoint patterns. <code class="bg-gray-900">greeting</code> is a dynamic variable, which neccesitates <code class="bg-gray-900">*</code>.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">resp.text = f&quot;{greeting}, world!</code> modifies the response object such that it&apos;s text will return a dynamic message based off <code class="bg-gray-900">greeting</code>. You can learn more about request and response objects at <a href="https://requests.readthedocs.io/en/master/" class="text-gray-700 font-bold bg-red-400">requests</a>.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">if __name__ == &apos;__main__&apos;:</code> uses some default python properties to establish that if this file is run, do what&apos;s below.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">api.run()</code> runs the app.</p>
<p class="mt-8 leading-loose">We can now save this file and test to see whether our endpoint is working.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">pipenv run python3 main.py</code></p>
<p class="mt-8 leading-loose">The default port that responder uses is <em class="italics">5042</em>, on localhost. You should be able to find it at <code class="bg-gray-900">localhost:5042/&lt;some greeting you put in&gt;</code>.</p>
<p class="mt-8 leading-loose">Now knowing that&apos;s working, we&apos;re going to shift towards setting up the database, before resuming working on the endpoints.</p>
<h2 class="text-3xl mt-8">Database setup</h2>
<p class="mt-8 leading-loose">EdgeDB is available for Unix, macOS, and docker. I&apos;ve found that when I attempt to install EdgeDB on macOS that the package doesn&apos;t quite install properly given that this is still alpha software.</p>
<p class="mt-8 leading-loose">The recommended method (and the way I did it) is through <a href="https://www.docker.com" class="text-gray-700 font-bold bg-red-400">Docker</a>. If you are unsure of what docker is, I was unsure of it too, up until yesterday.</p>
<p class="mt-8 leading-loose">Think of docker as an environment package manager, like pipenv. Instead of allowing us to port our project and it&apos;s environment, docker ports the entire operating system so that we can maintain better reproducibility. This is good for microservice architecture, where we may have many running parts that are tightly integrated with one another. It also makes docker cross-platform so any Windows users following this tutorial can continue.</p>
<p class="mt-8 leading-loose">To use docker, you should download it using your appropriate system package manager or through the official docker website. If you&apos;re doing this on Windows or macOS, I recommend downloading it from the site.</p>
<p class="mt-8 leading-loose">To download and enable it on Linux (particularly RHEL and SELinux based distros), you should run the following series of commands.</p>
<pre><code class="language-shell bg-gray-900">sudo dnf install docker
sudo systemctl start docker
</code></pre>
<p class="mt-8 leading-loose">This installs and runs the docker service. Upon doing this, you should be able to run docker containers. Docker maintains a large repository of pre-created docker containers in a central location called the <a href="https://hub.docker.com" class="text-gray-700 font-bold bg-red-400">Docker Hub</a>. This enables fast environment creation, as you are able to build upon and use other containers in your own.</p>
<p class="mt-8 leading-loose">EdgeDB maintains a container at the Docker Hub. To get this container, you should run the following:</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">docker pull edgedb/edgedb</code></p>
<p class="mt-8 leading-loose">This pulls the official container, maintained by magicstack.</p>
<p class="mt-8 leading-loose">To now run the container, we can follow the instructions given on the EdgeDB download site.</p>
<pre><code class="bg-gray-900">docker run --it --rm -p 5656:5656 -p 8888:8888 --name=edgedb-server -v &lt;datadir&gt;:/var/lib/edgedb/data edgedb/edgedb
</code></pre>
<p class="mt-8 leading-loose">You should replace <strong>&lt;datadir&gt;</strong> with the full path of a directory that you will use to store the edgedb data.</p>
<p class="mt-8 leading-loose">If you&apos;re attempting to run this on any RHEL or SELinux based distro, like I was, you should add <code class="bg-gray-900">--privileged</code> to get the docker container running.</p>
<p class="mt-8 leading-loose">Now that we have an edgedb instance running, we should instantiate our database. We can instantiate it by opening up a CLI inside the database.</p>
<p class="mt-8 leading-loose">Since we&apos;re running this in docker, we can&apos;t do this directly. What we need to do is spin up another docker instance containing this shell, that can connect to the database.</p>
<p class="mt-8 leading-loose">This is done through a similar command.</p>
<pre><code class="bg-gray-900">docker run --link=edgedb-server --rm -it edgedb/edgedb:latest edgedb -u edgedb -h edgedb-server
</code></pre>
<p class="mt-8 leading-loose">If you&apos;re using a RHEL or SELinux based distro, add <code class="bg-gray-900">--privileged</code> again.</p>
<p class="mt-8 leading-loose">We now have an edgedb prompt and can instantiate a database.</p>
<pre><code class="bg-gray-900">CREATE DATABASE saas_app;
\c saas_app
</code></pre>
<p class="mt-8 leading-loose">\c is a command to connect to the database.</p>
<p class="mt-8 leading-loose">The next thing to do is setup a schema for this database. If you don&apos;t know what a schema is, think of it as an outline of all the objects and things that go into this database and their relevant properties. We&apos;re gonna setup a really basic barebones schema.</p>
<pre><code class="bg-gray-900">START TRANSACTION;
CREATE MIGRATION  users TO {
    type User {
        required property email -&gt; str;
        required property passwordHash -&gt; str;
        required property active -&gt; bool;
    }
};
COMMIT MIGRATION users;
COMMIT;
</code></pre>
<p class="mt-8 leading-loose">I just threw alot at you, so I&apos;ll go over it line by line.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">START TRANSACTION</code> enables us to modify or change the schema.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">CREATE MIGRATION users TO {</code> is where we declare a data migration <em class="italics">users</em>, that is a change to the schema.</p>
<pre><code class="bg-gray-900">type User {
    required property email -&gt; str;
    required property passwordHash -&gt; str;
    required property active -&gt; bool;
}
</code></pre>
<p class="mt-8 leading-loose">This defines what object we&apos;re creating, its properties, and the type of its properties. We see here that we are defining a User model, with three properties, email, passwordHash, and active. Email and passwordHash are strings and active is a boolean. We require all of them.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">COMMIT MIGRATION users</code> makes the migration happen in the database.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">COMMIT</code> ends the transaction.</p>
<hr>
<p class="mt-8 leading-loose">If you, at any point in doing this, end up screwing up and get an error, do not fear.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">TransactionError: current transaction is aborted, commands ignored until end of transaction block</code></p>
<p class="mt-8 leading-loose">Since an error happened, edgedb won&apos;t let the migration continue. To fix this, run a rollback.</p>
<pre><code class="bg-gray-900">ROLLBACK;
</code></pre>
<p class="mt-8 leading-loose">You can then start the migration / schema from the beginning again.</p>
<hr>
<p class="mt-8 leading-loose">Quitting the edgedb console is as simple as <code class="bg-gray-900">\q</code>.</p>
<h2 class="text-3xl mt-8">Further API Setup</h2>
<p class="mt-8 leading-loose">We can now move back to the python API we were setting up.</p>
<p class="mt-8 leading-loose">A SaaS needs to have user accounts. This means that we need at minimum, two endpoints, <strong>/signup</strong> and <strong>/login</strong>. We can declare these routes and get rid of the greetings code from earlier.</p>
<pre><code class="language-python bg-gray-900">import responder
import validators
import edgedb

api = responder.API()

@api.route(&quot;/signup&quot;)
    async def signup(req, resp):
        ...

@api.route(&quot;/login&quot;)
    async def login(req, resp):
        ...
</code></pre>
<p class="mt-8 leading-loose">You can see that we&apos;ve removed the <code class="bg-gray-900">*</code> and <code class="bg-gray-900">greetings</code> parameters from earlier, because these are not going to be dynamic routes.</p>
<p class="mt-8 leading-loose">We&apos;re gonna split up the writing of these methods into two parts, data validation, and database entry.</p>
<h3>Data Validation</h3>
<p class="mt-8 leading-loose">We can&apos;t be sure that whatever is being sent to this server is not malicious. We also have to be aware that users can make dumb mistakes and just do stupid stuff. In order to combat this, we need to implement a couple of measures to make it harder.</p>
<p class="mt-8 leading-loose">The first thing we&apos;ll do is restrict the methods available for accessing this API. There are different HTTP methods for accessing a resource. We just want to allow requests that are are making POST requests, as they are sending us data that we respond back with. We can check if the request is of type POST with the following conditional:</p>
<pre><code class="language-python bg-gray-900">if req.method == &quot;post&quot;:
</code></pre>
<p class="mt-8 leading-loose">We check the client&apos;s request to ensure that it is of type post. POST must be lowercased, in order to meet responder&apos;s specs.</p>
<p class="mt-8 leading-loose">We can put <code class="bg-gray-900">pass</code> inside the if conditional, and return a different HTTP status code in the else statement. The full block looks like this:</p>
<pre><code class="language-python bg-gray-900">if req.method == &quot;post&quot;:
    pass
else:
    resp.status_code = api.status_codes.HTTP_405
    resp.text = &quot;405 Method Not Allowed&quot;
    return
</code></pre>
<p class="mt-8 leading-loose">We modify the response object that we&apos;ll send out to tell the client that the method in question is not allowed. You can find a full set of HTTP status codes on <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes" class="text-gray-700 font-bold bg-red-400">Wikipedia</a>.</p>
<p class="mt-8 leading-loose">If you&apos;d like to return a different status code, you can change the number that&apos;s appended at the end of <code class="bg-gray-900">api.status_codes</code> to match the error you&apos;d like to send.</p>
<p class="mt-8 leading-loose">The next step of validation is ensuring that whatever sent actually is what it&apos;s supposed to be. For <strong>/signup</strong> and <strong>/login</strong> that means two parameters.</p>
<ul class="list-square mt-8">
<li>email</li>
<li>passwordHash</li>
</ul>
<p class="mt-8 leading-loose">We need to make sure that <em class="italics">email</em> is actually an email. We can also impose a length max for <em class="italics">passwordHash</em> to ensure no flooding.</p>
<p class="mt-8 leading-loose">This is where <a href="https://validators.readthedocs.io/en/latest/" class="text-gray-700 font-bold bg-red-400"><strong>validators</strong></a>, the library I mentioned earlier, comes in. It&apos;s a no nonsense fast way to validate stuff, and isn&apos;t as complicated as other popular validation schema libraries.</p>
<p class="mt-8 leading-loose">We first need to get the response content. Since <strong>responder</strong> is an asynchronous framework, we need to wait until all of the request is loaded. To do this, we need to use <code class="bg-gray-900">await</code>.</p>
<pre><code class="language-python bg-gray-900">info = await req.media()
</code></pre>
<p class="mt-8 leading-loose">We await the data (<code class="bg-gray-900">req.media()</code>) from the response. We can then get the field names and store them variables.</p>
<pre><code class="language-python bg-gray-900">email = info.get(&quot;email&quot;)
passwordHash = info.get(&quot;passwordHash&quot;)
</code></pre>
<p class="mt-8 leading-loose">This done, we can now perform the data validation scheme.</p>
<pre><code class="language-python bg-gray-900">if validators.email(email) and len(passwordHash) == 32:
    pass
else:
    resp.status_code = api.status_codes.HTTP_400
    resp.text = &quot;400 Bad Request&quot;
    return
</code></pre>
<p class="mt-8 leading-loose">This ensures that we are, in fact, getting an email, and that the passwordHash is a hash. We can now move on to data entry and connection.</p>
<h3>Data Entry</h3>
<p class="mt-8 leading-loose">We must first connect to our database. Relevant documention for the edgedb python driver is <a href="https://edgedb.com/docs/clients/00_python/usage" class="text-gray-700 font-bold bg-red-400">here</a>.</p>
<pre><code class="language-python bg-gray-900">conn = await edgedb.async_connect(&apos;edgedb://edgedb@localhost/saas_app&apos;)
</code></pre>
<p class="mt-8 leading-loose">The nice thing about setting up edgeDB using docker, is that it instantiates a default database account to connect with. We will further deconstruct the connection string.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">edgedb://</code> is the protocol that states what database we&apos;re connecting to.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">edgedb</code> is the user.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">localhost</code> is the IP address for the database. In production, we&apos;d need to change this.</p>
<p class="mt-8 leading-loose"><code class="bg-gray-900">saas_app</code> is the name of our database.</p>
<p class="mt-8 leading-loose">We can now work on the <strong>/signup</strong> endpoint. The signup endpoint requires that we take in the <strong>email</strong> and <strong>passwordHash</strong> and create a new user account if the email isn&apos;t already present. So we&apos;ll first check if the user is present.</p>
<pre><code class="language-python bg-gray-900">await conn.fetchone(&apos;&apos;&apos;
    SELECT User {email} FILTER .email = &lt;str&gt;$email
    LIMIT 1
&apos;&apos;&apos;, email=email)
</code></pre>
<p class="mt-8 leading-loose">What this method, <code class="bg-gray-900">fetchone</code> does, is fetch one result from the query. The query is <a href="https://edgedb.com/docs/edgeql/overview" class="text-gray-700 font-bold bg-red-400">EdgeQL</a>, which is based off SQL. We select from our model <code class="bg-gray-900">User</code> all objects with <code class="bg-gray-900">email</code> where <code class="bg-gray-900">email</code> matches the email we got from the request object.</p>
<p class="mt-8 leading-loose">If it matches, we want to send a different response, and close the db connection.</p>
<pre><code class="language-python bg-gray-900">try:
    await conn.fetchone(&apos;&apos;&apos;
        SELECT User {email} FILTER .email = &lt;str&gt;$email
        LIMIT 1
    &apos;&apos;&apos;, email=email)
    resp.status_code = api.status_codes.HTTP_400
    resp.text = &quot;400 Bad Request&quot;
    await conn.close()
    return
except:
    await conn.fetchall(&apos;&apos;&apos;
        INSERT User {
            email := &lt;str&gt;$email,
            passwordHash := &lt;str&gt;$passwordHash,
            active := &lt;bool&gt;$active
        }
    &apos;&apos;&apos;, email=email, passwordHash=passwordHash, active=True)

await conn.close()
resp.text = &quot;Signup Complete!&quot;
</code></pre>
<p class="mt-8 leading-loose">Otherwise, we can proceed with signup. This is done through <code class="bg-gray-900">fetchall</code>, and an <code class="bg-gray-900">INSERT</code> query. If all goes well, we proceed to close the db connection and return a Response object that will print out &quot;Signup Complete!&quot;.</p>
<p class="mt-8 leading-loose">The <strong>/login</strong> endpoint is very similar to the <strong>/signup</strong> one. We keep the same try block, modifying it slightly.</p>
<pre><code class="language-python bg-gray-900">try:
    user = await conn.fetchone(&apos;&apos;&apos;
        SELECT User {email, passwordHash} FILTER .email = &lt;str&gt;$email AND .passwordHash = &lt;str&gt;$passwordHash
        LIMIT 1
    &apos;&apos;&apos;, email=email, passwordHash=passwordHash)
    resp.text = &quot;Login Successful&quot;
except:
    resp.status_code = api.status_codes.HTTP_400
    resp.text = &quot;Login Unsuccessful&quot;
</code></pre>
<p class="mt-8 leading-loose">We check to see if <code class="bg-gray-900">email</code> and <code class="bg-gray-900">passwordHash</code> match, and return successful if so. Otherwise, we throw another 400 bad request. We can proceed to close the database connection.</p>
<h2 class="text-3xl mt-8">Testing</h2>
<p class="mt-8 leading-loose">You now have an API endpoint connected to a database that is able to process signups and logins.</p>
<p class="mt-8 leading-loose">You now need to move towards testing this API endpoint. I find <a href="https://www.getpostman.com" class="text-gray-700 font-bold bg-red-400">Postman</a> to be an ideal tool for this sort of testing. You can also use the terminal and curl, but Postman really just makes it so much easier.</p>
<p class="mt-8 leading-loose">You can create a POST request in Postman, and change the type of the body to be <code class="bg-gray-900">xxx-form-encoded</code>. You can then include two keys, <code class="bg-gray-900">email</code> and <code class="bg-gray-900">passwordHash</code> and send out API requests in order to test whether your API is working. Remember to keep both the EdgeDB instance and responder server up when doing this.</p>
<h2 class="text-3xl mt-8">Conclusion</h2>
<p class="mt-8 leading-loose">You did it! If you appreciate this sort of content or have any sort of questions, please give me a follow on <a href="https://twitter.com/suchcaptcha" class="text-gray-700 font-bold bg-red-400">twitter</a>.</p></body></html></div></section></main><footer><nav class="flex justify-between max-w-4xl mx-auto p-4 md:p-8 text-sm"><p class="text-white"><a class="font-bold no-underline text-gray-800" href="/">Jonathan Wong</a> -<a class="font-bold text-blue-300" href="https://twitter.com/suchcaptcha">@suchcaptcha</a></p><p><a class="font-bold no-underline text-gray-800" href="https://github.com/unintendedcon">GitHub</a></p></nav></footer></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/articles/2020-01-16-prototyping-a-relational-saas-backend-using-responder-and-edgedb";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-c82e8ac8a837da01f4a6.js"],"component---src-pages-photos-js":["/component---src-pages-photos-js-f3d1c149fbb0d263e820.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-ee4887b5ff2b886d0d4e.js"],"component---src-templates-blog-template-js":["/component---src-templates-blog-template-js-68229942d75118d4628d.js"],"component---src-pages-index-js":["/component---src-pages-index-js-44ed1a492469c8454f24.js"],"component---src-pages-404-js":["/component---src-pages-404-js-08289a170c6b3381cf24.js"],"component---src-pages-about-js":["/component---src-pages-about-js-3ccebc5b51bfda5709c2.js"],"component---src-pages-blog-js":["/component---src-pages-blog-js-3d535c7ff20e4abb2b48.js"],"component---src-pages-contact-js":["/component---src-pages-contact-js-479e4480a7ce6df29bed.js"],"component---src-pages-goals-js":["/component---src-pages-goals-js-075afe7a558e531d4124.js"],"component---src-pages-lists-js":["/component---src-pages-lists-js-7447289cc6948e390b43.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-a16c258b430766dbb12f.js"]};/*]]>*/</script><script src="/component---src-templates-blog-template-js-68229942d75118d4628d.js" async=""></script><script src="/commons-7eee34bc71505e22bd57.js" async=""></script><script src="/styles-2672c646f9c7f9af2d1c.js" async=""></script><script src="/app-c82e8ac8a837da01f4a6.js" async=""></script><script src="/webpack-runtime-3e419a0487a4c0ed2972.js" async=""></script></body></html>